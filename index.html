<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Voice-Enabled Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/speechkitt.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        #skitt-ui {
            z-index: 1000 !important;
        }
    </style>
    <script>
        // Initialize the map
        var map = L.map('map').setView([50, 8], 5);
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Function to fly to coordinates based on city name
        const flyToCoords = function(city) {
            const inurl = "https://nominatim.openstreetmap.org/search?q=" + city + "&limit=1&format=json&addressdetails=1";
            console.log("City: " + city);
            $.ajax({
                url: inurl,
                dataType: "json",
                success: function(data) {
                    console.log("API Response: ", data);
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        map.flyTo([lat, lon], 12);
                        console.log("Flying to: ", [lat, lon]);
                    } else {
                        alert('Location not found. Please try another city');
                        console.log("Location not found.");
                    }
                },
                error: function() {
                    alert('Error retrieving location data. Please try again later.');
                    console.log("Error retrieving location data.");
                }
            });
        };

        // Function to stop listening
        const stopListening = function() {
            annyang.abort();
            console.log("Stopped listening.");
        };

        // Initialize annyang and set up commands
        if (annyang) {
            // Log all recognized speech
            annyang.addCallback('result', function(phrases) {
                console.log('Recognized phrase:', phrases[0]);
                console.log('Other possible phrases:', phrases);
            });

            // Configure SpeechKITT
            SpeechKITT.annyang();
            SpeechKITT.setStylesheet('//cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/themes/flat-clouds.css');
            SpeechKITT.setInstructionsText("Try 'Fly to Berlin' or any other city!");
            SpeechKITT.vroom();

            // Define voice commands
            const commands = {
                'hello': () => { alert('Hey there, try some commands!'); },
                'go to *city': flyToCoords,
                'stop listening': stopListening
            };
            annyang.addCommands(commands);
            annyang.start();
            console.log("Voice recognition started.");
        } else {
            console.log("annyang is not supported in this browser.");
        }
    </script>
</body>
</html>
